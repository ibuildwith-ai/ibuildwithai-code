/**
 * Blog References Accordion Component
 * Wraps Hugo-generated footnotes in a collapsible accordion
 * Automatically handles citation clicks to expand and scroll to references
 */
(function() {
    // Find the footnotes div generated by Hugo
    const footnotesDiv = document.querySelector('.footnotes');

    // Exit if no footnotes exist on this page
    if (!footnotesDiv) return;

    // Count total footnotes
    const footnoteItems = footnotesDiv.querySelectorAll('ol li');
    const footnoteCount = footnoteItems.length;

    // Hide Hugo's default horizontal rule
    const hr = footnotesDiv.querySelector('hr');
    if (hr) {
        hr.style.display = 'none';
    }

    // Create accordion wrapper structure
    const accordionWrapper = document.createElement('div');
    accordionWrapper.className = 'faq-accordion references-accordion';
    accordionWrapper.setAttribute('data-faq-accordion', '');

    // Create accordion item
    const accordionItem = document.createElement('div');
    accordionItem.className = 'faq-item';
    accordionItem.setAttribute('data-faq-item', '');

    // Create accordion header (clickable)
    const accordionHeader = document.createElement('button');
    accordionHeader.className = 'faq-header';
    accordionHeader.setAttribute('data-faq-toggle', '');
    accordionHeader.setAttribute('aria-expanded', 'false');
    accordionHeader.setAttribute('aria-controls', 'references-content');

    // Create header content with count
    const headerQuestion = document.createElement('div');
    headerQuestion.className = 'faq-question';
    headerQuestion.textContent = `References (${footnoteCount})`;

    // Create chevron icon
    const chevron = document.createElement('div');
    chevron.className = 'faq-chevron';
    chevron.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 6l4 4 4-4"/></svg>';

    // Assemble header
    accordionHeader.appendChild(headerQuestion);
    accordionHeader.appendChild(chevron);

    // Create accordion content wrapper
    const accordionContent = document.createElement('div');
    accordionContent.className = 'faq-content';
    accordionContent.id = 'references-content';
    accordionContent.setAttribute('hidden', '');

    // Create answer wrapper
    const accordionAnswer = document.createElement('div');
    accordionAnswer.className = 'faq-answer';

    // Move footnotes into accordion
    accordionAnswer.appendChild(footnotesDiv.cloneNode(true));
    accordionContent.appendChild(accordionAnswer);

    // Assemble accordion structure
    accordionItem.appendChild(accordionHeader);
    accordionItem.appendChild(accordionContent);
    accordionWrapper.appendChild(accordionItem);

    // Replace original footnotes with accordion
    footnotesDiv.parentNode.replaceChild(accordionWrapper, footnotesDiv);

    // Add accordion toggle functionality
    let isExpanded = false;

    function toggleAccordion() {
        isExpanded = !isExpanded;
        accordionHeader.setAttribute('aria-expanded', isExpanded);

        if (isExpanded) {
            accordionContent.removeAttribute('hidden');
            accordionItem.classList.add('active');
        } else {
            accordionContent.setAttribute('hidden', '');
            accordionItem.classList.remove('active');
        }
    }

    function openAccordion() {
        if (!isExpanded) {
            toggleAccordion();
        }
    }

    // Click handler for header
    accordionHeader.addEventListener('click', function(e) {
        e.preventDefault();
        toggleAccordion();
    });

    // Keyboard support
    accordionHeader.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleAccordion();
        }
    });

    // Handle citation clicks in body content
    // Hugo generates superscript links like <sup id="fnref:1"><a href="#fn:1">...</a></sup>
    const citationLinks = document.querySelectorAll('a[href^="#fn:"]');

    citationLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            // Open accordion if closed
            openAccordion();

            // Get footnote ID from href (e.g., "#fn:1" -> "fn:1")
            const footnoteId = link.getAttribute('href').substring(1);

            // Wait for accordion animation to complete before scrolling
            setTimeout(function() {
                const footnoteElement = document.getElementById(footnoteId);

                if (footnoteElement) {
                    // Scroll to footnote with smooth behavior
                    footnoteElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Add highlight animation
                    footnoteElement.classList.add('footnote-highlight');

                    // Remove highlight after animation completes
                    setTimeout(function() {
                        footnoteElement.classList.remove('footnote-highlight');
                    }, 2000);
                }
            }, 300); // Match FAQ accordion animation duration
        });
    });

    // Handle backlink clicks (↩︎) from references to body content
    // Hugo generates backlinks like <a href="#fnref:1" class="footnote-backref">↩︎</a>
    const backlinkElements = document.querySelectorAll('.footnote-backref');

    backlinkElements.forEach(function(backlink) {
        backlink.addEventListener('click', function(e) {
            e.preventDefault();

            // Get the citation ID from href (e.g., "#fnref:1" -> "fnref:1")
            const citationId = backlink.getAttribute('href').substring(1);
            const citationElement = document.getElementById(citationId);

            if (citationElement) {
                // Get header height for offset calculation
                const header = document.querySelector('.header');
                const headerHeight = header ? header.offsetHeight : 0;
                const offset = 20; // Additional padding below header

                // Calculate position to scroll to
                const elementPosition = citationElement.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerHeight - offset;

                // Scroll to position with smooth behavior
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });

                // Add highlight animation to the citation
                citationElement.classList.add('footnote-highlight');

                // Remove highlight after animation completes
                setTimeout(function() {
                    citationElement.classList.remove('footnote-highlight');
                }, 2000);
            }
        });
    });
})();
